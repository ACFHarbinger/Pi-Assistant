name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  # ── Rust ────────────────────────────────────────────────────────────
  lint-rust:
    name: Lint & Format (Rust)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install System Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libwebkit2gtk-4.1-dev libsoup-3.0-dev libjavascriptcoregtk-4.1-dev libasound2-dev
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy
      - uses: Swatinem/rust-cache@v2
      - name: Rust Format Check
        run: cargo fmt --all -- --check
      - name: Create Dummy Frontend Dist
        run: |
          mkdir -p dist
          touch dist/index.html
      - name: Rust Clippy
        run: cargo clippy --workspace -- -D warnings

  test-rust:
    name: Test & Coverage (Rust)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install System Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libwebkit2gtk-4.1-dev libsoup-3.0-dev libjavascriptcoregtk-4.1-dev libasound2-dev
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
      - name: Install Coverage Tool
        run: cargo install cargo-tarpaulin
      - name: Create Dummy Frontend Dist
        run: |
          mkdir -p dist
          touch dist/index.html
      - name: Rust Tests & Coverage
        run: cargo tarpaulin --out Xml --output-dir target/tarpaulin
      - name: Upload Rust Coverage
        uses: codecov/codecov-action@v5
        with:
          files: ./target/tarpaulin/cobertura.xml
          flags: rust

  # ── Python ──────────────────────────────────────────────────────────
  lint-python:
    name: Lint & Format (Python)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true
      - name: Install Lint Dependencies
        run: uv sync
      - name: Python Format Check
        run: uv run ruff format --check .
      - name: Python Lint Check
        run: uv run ruff check .

  test-python:
    name: Test & Coverage (Python)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true
      - name: Install Dependencies
        run: uv sync
      - name: Python Tests & Coverage
        run: uv run pytest --cov=sidecars --cov-report=xml:python-coverage.xml
      - name: Upload Python Coverage
        uses: codecov/codecov-action@v5
        with:
          files: ./python-coverage.xml
          flags: python

  # ── Frontend ───────────────────────────────────────────────────────
  lint-frontend:
    name: Lint & Format (Frontend)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "npm"
      - name: Install Dependencies
        run: npm ci
      - name: Frontend Format Check
        run: npm run format -- --check
      - name: Frontend Type Check
        run: npm run build # Verifies tsc

  test-frontend:
    name: Test & Coverage (Frontend)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "npm"
      - name: Install Dependencies
        run: npm ci
      - name: Frontend Tests & Coverage
        run: npm run test -- --coverage
      - name: Upload TypeScript Coverage
        uses: codecov/codecov-action@v5
        with:
          files: ./coverage/clover.xml
          flags: typescript
